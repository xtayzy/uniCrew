# Система аутентификации с JWT токенами

## Что было исправлено

### Backend (Django)
1. **Настройки JWT** - исправлены настройки `SIMPLE_JWT` в `settings.py`:
   - Access токен: 15 минут
   - Refresh токен: 7 дней
   - Включен ротационный refresh токен
   - Правильная конфигурация для стандартных JWT токенов

### Frontend (React)
1. **AuthContext** - полностью переписан с улучшениями:
   - Автоматическое добавление токенов в запросы
   - Умное обновление токенов при 401 ошибках
   - Предотвращение множественных запросов на обновление
   - Правильная обработка ошибок

2. **API клиент** - создан `apiClient.js` для централизованной работы с API

3. **Хук useAuth** - создан удобный хук для работы с аутентификацией

4. **Компонент TokenStatus** - для отладки и мониторинга токенов

## Как это работает

### Автоматическое обновление токенов
- Токены обновляются каждые 14 минут (за 1 минуту до истечения access токена)
- При получении 401 ошибки система автоматически пытается обновить токены
- Если обновление не удается, пользователь автоматически выходит из системы

### Безопасность
- Refresh токены ротируются при каждом обновлении
- Токены хранятся в localStorage
- Автоматическая очистка при истечении refresh токена

### Обработка ошибок
- Улучшенная обработка ошибок входа
- Автоматический logout при проблемах с токенами
- Индикаторы загрузки в UI

## Использование

### В компонентах
```jsx
import { useAuth } from '../hooks/useAuth';

function MyComponent() {
    const { isAuth, tokens, logout, refreshTokens } = useAuth();
    
    // Использование состояния аутентификации
    if (!isAuth) {
        return <div>Пожалуйста, войдите в систему</div>;
    }
    
    return <div>Добро пожаловать!</div>;
}
```

### API запросы
```jsx
import apiClient from '../api/apiClient';

// Токены автоматически добавляются в заголовки
const response = await apiClient.get('/users/');
```

### Отладка
Компонент `TokenStatus` показывает:
- Время до истечения access токена
- Статус refresh токена
- Процесс обновления токенов

## Настройки

### Изменение времени жизни токенов
В `settings.py`:
```python
SIMPLE_JWT = {
    'ACCESS_TOKEN_LIFETIME': timedelta(minutes=15),  # Измените здесь
    'REFRESH_TOKEN_LIFETIME': timedelta(days=7),     # И здесь
    # ...
}
```

### Изменение интервала обновления
В `AuthContext.jsx`:
```javascript
// Измените интервал (в миллисекундах)
}, 14 * 60 * 1000); // 14 минут
```

## Устранение неполадок

1. **Токены не обновляются** - проверьте настройки CORS и URL API
2. **Постоянные 401 ошибки** - убедитесь, что сервер возвращает правильные токены
3. **Проблемы с localStorage** - проверьте, что браузер поддерживает localStorage

## Удаление компонента отладки

Когда система работает стабильно, удалите `TokenStatus` из `App.jsx`:
```jsx
// Удалите эту строку
<TokenStatus />
```
